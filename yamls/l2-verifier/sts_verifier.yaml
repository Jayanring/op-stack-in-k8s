apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: l2-verifier
spec:
  replicas: 1
  serviceName: ""
  selector:
    matchLabels:
      app: l2-verifier
  template:
    metadata:
      labels:
        app: l2-verifier
    spec:
      volumes:
        - persistentVolumeClaim:
            claimName: l2-config-pvc
          name: l2-config
      initContainers:
        - name: init-container
          image: jayanring/op-geth
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "datadir: $(ls /datadir)";
              if [ ! "$(ls -A /datadir)" ]; then
                echo "init geth" && geth init --datadir=/datadir /config/genesis.json
              fi
          volumeMounts:
            - mountPath: /config
              name: l2-config
            - mountPath: /datadir
              name: datadir-verifier
      containers:
        - name: op-geth
          image: jayanring/op-geth
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-c"]
          args:
            - |
              geth --datadir /datadir --http --http.corsdomain="*" --http.vhosts="*" --http.addr=0.0.0.0 \
              --http.api=web3,debug,eth,txpool,net,engine --ws --ws.addr=0.0.0.0 --ws.port=8546 --ws.origins="*" \
              --ws.api=debug,eth,txpool,net,engine --syncmode=full --gcmode=archive --authrpc.jwtsecret=/config/jwt.txt \
              --networkid=$(cat /config/L2_ChainID) --authrpc.vhosts="*" --authrpc.addr=0.0.0.0 --authrpc.port=8551 \
              --bootnodes=enode://[OP_GETH_P2P]@l2-sequencer-p2p:30303
          volumeMounts:
            - mountPath: /config
              name: l2-config
            - mountPath: /datadir
              name: datadir-verifier
          ports:
            - containerPort: 8545
              name: op-geth-rpc
              protocol: TCP
            - containerPort: 8551
              name: authrpc
              protocol: TCP
          resources:
            limits:
              cpu: 8000m
              memory: 16392Mi
            requests:
              cpu: 1000m
              memory: 2048Mi
        - name: op-node
          image: jayanring/op-node
          imagePullPolicy: Always
          command: ["/bin/sh", "-c"]
          args:
            - |
              op-node \
              --l1=$(cat /config/ETH_RPC_URL)  \
              --l1.rpckind=basic \
              --l2=http://localhost:8551/ \
              --l2.jwt-secret=/config/jwt.txt \
              --rollup.config=/config/rollup.json \
              --rpc.addr=0.0.0.0 \
              --rpc.port=8547 \
              --p2p.static /dns4/l2-sequencer-p2p/tcp/9222/p2p/[OP_NODE_P2P]
          volumeMounts:
            - mountPath: /config
              name: l2-config
          ports:
            - containerPort: 8547
              name: op-node-rpc
              protocol: TCP
          resources:
            limits:
              cpu: 8000m
              memory: 16392Mi
            requests:
              cpu: 1000m
              memory: 2048Mi
  podManagementPolicy: OrderedReady
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: datadir-verifier
    spec:
      accessModes:
      - ReadWriteMany
      resources:
        requests:
          storage: 10Gi
      storageClassName: nas-client-provisioner
      volumeMode: Filesystem
            
